
### 1.背景【可选】

<pre>
当应用由原单体服务方式转换成为以微服务化架构后，原本当后台应用接收到请求时，所有业务逻辑的处理均在同一个运行容器（对应一个JVM）中完成执行，现在则需要在多台服务器间进行多次的服务交互才能完成，每一个服务所修改的数据大多还不在一个数据库中；后端的数据库由原来的单一数据库集群（即所有数据均在同一数据库中）按照业务的维度进行了划分到不同数据库集群，对于原来应用中利用数据库事务特性解决的事务性问题在新的技术体系下给应用开发带来了新的挑战。
本项目解决的问题：
一、在分布式服务架构中，如何通过业务流程异步化，即通过服务异步调用的方式让业务流程中业务逻辑上允许同步执行的服务同时被异步调用，从而解决大量远程服务线性调用带来的性能问题。
二、在数据进行分库分表后，数据在进行异步操作的场景下，采用异步化事务处理方式实现该数据最终一致性的问题。

本项目事务消息管理，以下简称为（TMM）；TMM由深圳架构组团队独立研发及运维。
该项目将按如下步骤逐步推进：
第一阶段：
完成事务消息可靠性传输功能研发；
第二阶段：
完成生产者及消费者事务人工干预功能研发，及两阶段分布式事务功能的方案预研；
第三阶段：
完成TMM整个调用链的数据及性能的可视化监控；
第四阶段：
完成rabbitmq， rocketmq等多消息中间件的接入；

</pre>

###  2.术语定义【可选】

<pre>

TMM                         transactional message manager 事务消息管理器 
TMM-CLIENT                  消息发送者客户端
TMM-ADMIN                   事务消息控制台
    
</pre>


### 3.功能清单

*<说明此版本在当前迭代内需要完成的需求功能清单，对应测试验收功能列表 >*
 
<pre>

发送端：启动加载初始数据
    启动加载分析MAP，加载检测点（checkpoint），加载待发送MQ（mqMap）

发送端：事务日志本地持久化
    事务日志本地持久化刷盘，刷盘切片大小可配置

发送端：事务事件分析
    事务开始日志本地缓存，结束日志匹配开始日志，合并生产发送MQ

发送端：异常事件分析
    只有开始日志未匹配到结束日志数据，超出特定时间，将作为异常事件处理

发送端：消息确认模式发送
    消息发送采用多线程并行发送，异步确认方案，确保消息被MQ中间件完整接收

发送端：已发送未确认消息重发
    消息发送后，超出特定时间，未收到确认需要重新发送

发送端：变更缓存持久化
    单次事件分析循环内：分析缓存，消息缓存发生变更后需要持久化刷盘

发送端：事务日志检测点变更
    事务日志循环分析检测点，当整个循环业务正常处理，则正常变更，否则保留原检测点重复处理，直到成功为止；

消费端：消费消息异常
    消费者异常消费，消息数据进入死信队列；

消费端：消息无消费者
    消息存储队列中，超出特定时间，消息进入死信队列；

消费端：死信消息
    死信数据进入tmm-admin可人工干预，重发进入消息队列，或废弃；

管理端：异常消息
    管理端针对回调发送端事件消息，持续异常，此消息变更为异常状态；管理端针对发送消息到MQ中间件，持续异常，此消息变更为死亡状态

管理端：死信消息
    管理端针对已订阅死信消息，回发到正常队列；

发送端：发送事务日志双写
    发送事务日志双写到不同磁盘，防止磁盘损坏，导致数据丢失；

</pre>




### 业务数据时序图【可选】
*<最终应用与其他服务之间的数据交换流程；展现功能对应各服务之间调用关系，为系统功能的调用关系描述，如果在开发过程中设计发生变化，本节也应当做相应变更。 >*


![](http://git.tuandai888.com/jiangguqiang/tmm/blob/master/design/img/sjwd4-1.png)

【img 4-1】




### 5.系统架构图【可选】
*<最终应用各模块在整个系统中的组合关系（客户端，网关，应用，数据，监控及第三方服务等），如果在开发过程中设计发生变化，本节也应当做相应变更。>*


![](http://git.tuandai888.com/jiangguqiang/tmm/blob/master/design/img/sjwd5-1.png)
【img 5-1】



![](http://git.tuandai888.com/jiangguqiang/tmm/blob/master/design/img/sjwd5-2.png)
【img 5-2】



### 6.物理部署图【可选】
*<从业务出发将需求功能按模块划分为不同子服务，展示服务上线所需的服务器，各子应用部署到规划好的服务器对应关系图，如果在研发过程中设计发生变化，本节也应当做相应变更。>*


![](http://git.tuandai888.com/jiangguqiang/tmm/blob/master/design/img/sjwd6-1.png)
【img 6-1】



### 7.数据结构设计
*<研发中涉及的所有数据层中间件设计： 关系型数据库，非关系型数据库，文件系统，缓存服务，日志文件等;如果在研发过程中设计发生变化，本节也应当做相应变更。>*

#### TMM-CLIENT

##### 事务日志数据格式

开始事务日志：  BeginLog  

| 字段        | 类型    |  空  | 默认值    |注解          |
| ---------   | -----   | ---- | ------    |------        |
|uid          | String  |  否  |           |UUID          |
|serviceName  | String  |  否  |           |服务名        |
|Topic        | Json    |  是  |           |对应不同MQ的topic定义|
|Message      | Json    |  是  |           |发送的MQ消息体|
|Check        | String  |  是  |           |回调Url地址 |



### 2.术语定义【可选】

<pre>

TMM                         transactional message manager 事务消息管理器 
TMM-CLIENT                  消息发送者客户端
TMM-ADMIN                   事务消息控制台
    
</pre>

| 水果        | 价格    |  数量  |
| --------   | -----:   | :----: |
| 香蕉        | $1      |   5    |
| 苹果        | $1      |   6    |
| 草莓        | $1      |   7    |



